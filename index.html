
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kiosco ssj</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://res.cloudinary.com/dg6kgosio/image/upload/v1758058435/8879d05e-30ea-40bd-a1c2-b14771fe106c-fotor-20250916183328_bubhbn.png" type="image/png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #10180f; /* Fondo principal oscuro (casi negro) */
            background: linear-gradient(135deg, #10180f, #283a2a, #1a2a1b);
            color: #e2e8f0;
            margin: 0;
            overflow-x: hidden;
        }
        .glass-card {
            background-color: rgba(16, 24, 15, 0.4); /* Fondo semi-transparente verde oscuro */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 231, 106, 0.2); /* Borde de verde claro semi-transparente */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .glass-card:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
        .nav-item {
            position: relative;
            z-index: 10;
        }
        .nav-item:hover {
            color: #a3e635; /* Verde lima vibrante al pasar el mouse */
        }
        .nav-item-active {
            color: #fff;
            background-color: #4ade80; /* Verde brillante para el botón activo */
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
            font-weight: bold;
        }
        .nav-item-active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.5rem;
            background-color: rgba(74, 222, 128, 0.5);
            z-index: -1;
            transition: opacity 0.3s ease-in-out;
        }
        .nav-item-active:hover::before {
            opacity: 1;
        }
        .neon-button {
            box-shadow: 0 0 5px #a3e635, 0 0 10px #a3e635, 0 0 15px #a3e635;
            transition: all 0.3s ease-in-out;
        }
        .neon-button:hover {
            box-shadow: 0 0 10px #4ade80, 0 0 20px #4ade80, 0 0 30px #4ade80;
        }
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4ade80 #2d3748;
        }
        .main-content::-webkit-scrollbar {
            width: 8px;
        }
        .main-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .main-content::-webkit-scrollbar-thumb {
            background-color: #4ade80;
            border-radius: 20px;
            border: 2px solid #2d3748;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        
    /* Estilos adicionales para que el texto de los filtros sea visible */
    #productSearch,
    #categoryFilter {
        color: #e2e8f0; /* Color de texto claro para visibilidad */
    }
    </style>
</head>
<body class="text-gray-200">

    <div class="flex h-screen bg-transparent">
        <aside class="hidden md:flex flex-col w-64 glass-card m-2">
            <div class="flex items-center justify-center h-20 border-b border-emerald-500/30">
                <img src="https://res.cloudinary.com/dg6kgosio/image/upload/v1758058435/8879d05e-30ea-40bd-a1c2-b14771fe106c-fotor-20250916183328_bubhbn.png" class="h-12 w-12 rounded-full mr-2">
                <span class="ml-2 text-xl font-bold">kiosco ssj</span>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#dashboard" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200 nav-item-active">Dashboard</a>
                <a href="#products" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Productos</a>
                <a href="#sales" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Ventas</a>
                <a href="#reports" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Reportes</a>
                <a href="#balance" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Balance</a>
                <a href="#history" class="nav-item flex items-center px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Historial</a>
            </nav>
            <div class="p-4 border-t border-emerald-500/30">
                <button id="resetDailySalesBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg neon-button">
                    Reiniciar Ventas del Día
                </button>
            </div>
        </aside>

        <main class="flex-1 main-content p-4 md:p-6">
            <section id="dashboard" class="content-section">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-6 flex flex-col justify-between">
                        <h3 class="text-lg font-semibold text-gray-400">Ventas Hoy</h3>
                        <p id="salesToday" class="text-4xl font-bold text-emerald-400">$0.00</p>
                    </div>
                    <div class="glass-card p-6 flex flex-col justify-between">
                        <h3 class="text-lg font-semibold text-gray-400">Ganancia Hoy</h3>
                        <p id="profitToday" class="text-4xl font-bold text-green-400">$0.00</p>
                    </div>
                    <div class="glass-card p-6 flex flex-col justify-between">
                        <h3 class="text-lg font-semibold text-gray-400">Ganancia Semana</h3>
                        <p id="profitWeek" class="text-4xl font-bold text-green-400">$0.00</p>
                    </div>
                    <div class="glass-card p-6 flex flex-col justify-between">
                        <h3 class="text-lg font-semibold text-gray-400">Ganancia Mes</h3>
                        <p id="profitMonth" class="text-4xl font-bold text-green-400">$0.00</p>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-emerald-300">Ganancias de la Semana</h2>
                        <div class="chart-container">
                            <canvas id="weeklyProfitChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-emerald-300">Stock Crítico (<5 unidades)</h2>
                        <div id="criticalStock" class="space-y-2 max-h-80 overflow-y-auto">
                            <p class="text-gray-400">No hay productos con stock crítico.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="products" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Gestión de Productos</h1>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <div class="flex gap-4">
                        <input type="text" id="productSearch" placeholder="Buscar producto..." class="bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <select id="categoryFilter" class="bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <button id="addProductBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg neon-button">Agregar Producto</button>
                </div>
                <div class="glass-card overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-emerald-500/30">
                            <tr>
                                <th class="p-4">Nombre</th>
                                <th class="p-4">Categoría</th>
                                <th class="p-4">Stock</th>
                                <th class="p-4">Costo</th>
                                <th class="p-4">Precio Venta</th>
                                <th class="p-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="sales" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Registrar Venta</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold mb-4">Productos Disponibles</h2>
                        <input type="text" id="saleProductSearch" placeholder="Buscar producto..." class="w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 mb-4 focus:ring-emerald-500 focus:border-emerald-500">
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead class="border-b border-emerald-500/30 sticky top-0 bg-[#171141] bg-opacity-90 backdrop-blur-sm">
                                    <tr>
                                        <th class="p-4">Producto</th>
                                        <th class="p-4 text-center">Stock</th>
                                        <th class="p-4 text-center">Precio</th>
                                        <th class="p-4 text-center">Agregar</th>
                                    </tr>
                                </thead>
                                <tbody id="availableProductsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-bold mb-4">Venta en Curso</h2>
                        <form id="saleForm" class="space-y-4">
                            <div class="overflow-x-auto h-64">
                                <table class="w-full text-left">
                                    <thead class="border-b border-emerald-500/30">
                                        <tr>
                                            <th class="p-4">Producto</th>
                                            <th class="p-4 text-center">Cant.</th>
                                            <th class="p-4 text-center">Precio</th>
                                            <th class="p-4 text-right">Subtotal</th>
                                            <th class="p-4"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="currentSaleTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="border-t border-emerald-500/30 pt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold">Total:</h3>
                                    <p id="saleTotal" class="text-3xl font-bold text-green-400">$0.00</p>
                                </div>
                                <div>
                                    <label for="salePaymentMethod" class="block mb-2 text-sm font-medium text-gray-300">Método de Pago</label>
                                    <select id="salePaymentMethod" required class="w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                                        <option>Efectivo</option>
                                        <option>Tarjeta</option>
                                        <option>Transferencia</option>
                                    </select>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg neon-button">Confirmar Venta</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="reports" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Reportes y Balances</h1>
                <div class="flex justify-end mb-4">
                    <button id="exportCsvBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg neon-button">Exportar CSV</button>
                </div>
                <div class="glass-card overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-emerald-500/30">
                            <tr>
                                <th class="p-4">Producto</th>
                                <th class="p-4">Unidades Vendidas</th>
                                <th class="p-4">Ventas Totales</th>
                                <th class="p-4">Ganancia Total</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="balance" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Balance de la Planta</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-emerald-300">Stock por Categoría</h2>
                        <div id="categoryBalance" class="space-y-4">
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-emerald-300">Distribución de Stock</h2>
                        <div class="chart-container mx-auto" style="max-width: 400px;">
                            <canvas id="categoryStockChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="history" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6 text-emerald-300">Historial de Ventas</h1>
                <div class="glass-card p-6 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-emerald-500/30">
                            <tr>
                                <th class="p-4">ID</th>
                                <th class="p-4">Fecha y Hora</th>
                                <th class="p-4">Total</th>
                                <th class="p-4">Ganancia</th>
                                <th class="p-4">Método de Pago</th>
                                <th class="p-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 glass-card flex justify-around p-2 border-t border-emerald-500/30">
        <a href="#dashboard" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6 nav-item-active">Dashboard</a>
        <a href="#products" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6">Productos</a>
        <a href="#sales" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6">Ventas</a>
        <a href="#reports" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6">Reportes</a>
        <a href="#balance" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6">Balance</a>
        <a href="#history" class="nav-item flex flex-col items-center text-xs p-2 rounded-lg w-1/6">Historial</a>
    </nav>

    <div id="productModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="glass-card p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-emerald-300">Agregar Producto</h2>
                <button type="button" id="exitProductAdminBtn" class="hidden text-red-400 hover:text-red-600 font-bold py-2 px-4 rounded-lg neon-button">Salir</button>
            </div>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-300">Nombre</label>
                    <input type="text" id="productName" required class="mt-1 w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="productCategory" class="block text-sm font-medium text-gray-300">Categoría</label>
                    <input type="text" id="productCategory" required class="mt-1 w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="productStock" class="block text-sm font-medium text-gray-300">Stock</label>
                        <input type="number" id="productStock" required min="0" class="mt-1 w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="productCost" class="block text-sm font-medium text-gray-300">Costo Unitario</label>
                        <input type="number" id="productCost" required min="0" step="0.01" class="mt-1 w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>
                <div>
                    <label for="productPrice" class="block text-sm font-medium text-gray-300">Precio Venta</label>
                    <input type="number" id="productPrice" required min="0" step="0.01" class="w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="productImage" class="block text-sm font-medium text-gray-300">URL de Imagen (Opcional)</label>
                    <input type="text" id="productImage" class="mt-1 w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancelProductBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg neon-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="adminModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="glass-card p-8 rounded-lg shadow-2xl w-full max-w-md m-4 text-center">
            <img src="https://res.cloudinary.com/dg6kgosio/image/upload/v1758058435/8879d05e-30ea-40bd-a1c2-b14771fe106c-fotor-20250916183328_bubhbn.png" class="h-16 w-16 mx-auto mb-4 rounded-full">
            <h2 id="adminModalTitle" class="text-2xl font-bold mb-4 text-emerald-300">Confirmación de Administrador</h2>
            <p id="adminModalMessage" class="text-gray-400 mb-6">Ingresa la contraseña para confirmar la acción.</p>
            <form id="adminForm" class="space-y-4">
                <input type="password" id="adminPasswordInput" placeholder="Contraseña de Administrador" required class="w-full bg-gray-700/50 border border-emerald-500/30 rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500">
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancelAdminBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg neon-button">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%]" style="transition: transform 0.5s ease-in-out; z-index: 1000;">
        <p id="toastMessage"></p>
    </div>

    <script>
        // Funciones de utilidad 
        function $(id) {
            return document.getElementById(id);
        }

        function formatCurrency(amount) {
            return `$${parseFloat(amount).toFixed(2)}`;
        }

        function showToast(message, type = 'success') {
            const toast = $('toast');
            const toastMessage = $('toastMessage');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-500 ease-in-out ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} translate-x-0`;
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 3000);
        }

        // Variable para almacenar el callback de la acción administrativa
        let adminActionCallback = null;
        let isAdminSessionActive = false; // Nueva variable de estado para la sesión de admin
        let currentAdminSection = ''; // 'products', 'edit', 'delete', 'history'

        // Modal de administrador
        const adminModal = $('adminModal');
        const adminPasswordInput = $('adminPasswordInput');
        const adminForm = $('adminForm');
        const adminPassword = 'Messi2022'; // La contraseña por defecto
        
        // Función para mostrar el modal de contraseña y ejecutar una acción si es correcta
        function promptForPassword(callback, section) {
            currentAdminSection = section;
            adminActionCallback = callback;
            adminPasswordInput.value = '';
            $('adminModalTitle').textContent = 'Confirmación de Administrador';
            $('adminModalMessage').textContent = 'Ingresa la contraseña para confirmar la acción.';
            $('cancelAdminBtn').textContent = 'Cancelar';
            $('adminModal').classList.remove('hidden');
            $('adminModal').classList.add('flex');
        }

        // Evento de confirmación en el modal de admin
        adminForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (adminPasswordInput.value === adminPassword) {
                if (currentAdminSection === 'history') {
                    // Para el historial, la contraseña se pide cada vez, así que no se activa la sesión
                    adminModal.classList.remove('flex');
                    adminModal.classList.add('hidden');
                    if (adminActionCallback) {
                        adminActionCallback();
                        adminActionCallback = null;
                    }
                } else {
                    isAdminSessionActive = true;
                    adminModal.classList.remove('flex');
                    adminModal.classList.add('hidden');
                    showToast('Sesión de administrador iniciada.', 'success');
                    if (adminActionCallback) {
                        adminActionCallback();
                        adminActionCallback = null;
                    }
                    // Mostrar el botón de Salir solo si la sesión está activa y no estamos en la sección de historial
                    $('exitProductAdminBtn').classList.remove('hidden');
                }
            } else {
                showToast('Contraseña incorrecta.', 'error');
            }
        });

        $('cancelAdminBtn').addEventListener('click', () => {
            adminModal.classList.remove('flex');
            adminModal.classList.add('hidden');
            adminActionCallback = null;
        });

        // Lógica de Salir de la sesión de admin
        $('exitProductAdminBtn').addEventListener('click', () => {
            isAdminSessionActive = false;
            $('productModal').classList.add('hidden');
            $('productModal').classList.remove('flex');
            $('exitProductAdminBtn').classList.add('hidden');
            showToast('Sesión de administrador cerrada.', 'success');
        });

        // Almacenamiento y gestión de datos en localStorage
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
        let currentSale = JSON.parse(localStorage.getItem('currentSale')) || [];

        function saveData() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('currentSale', JSON.stringify(currentSale));
        }

        // Lógica de navegación
        const navLinks = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        function switchSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            navLinks.forEach(link => {
                link.classList.remove('nav-item-active');
            });

            const activeSection = document.querySelector(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }
            const activeLink = document.querySelector(`a[href="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('nav-item-active');
            }
        }

        // Navegación con hash
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash || '#dashboard';
            switchSection(hash);
            renderAll();
        });

        // Inicializar al cargar la página
        window.onload = () => {
            const hash = window.location.hash || '#dashboard';
            switchSection(hash);
            renderAll();
        };

        // Renderizado de las secciones
        function renderAll() {
            renderDashboard();
            renderProductsTable();
            renderAvailableProductsTable();
            renderCurrentSale();
            renderReportsTable();
            renderBalanceCharts();
            renderHistoryTable();
            populateCategoryFilter();
        }

        // Dashboard
        let weeklyProfitChart = null;
        let categoryStockChart = null;

        function renderDashboard() {
            // Cálculos de KPIs
            const today = new Date().toDateString();
            const salesToday = salesHistory.filter(sale => new Date(sale.date).toDateString() === today);
            const totalSalesToday = salesToday.reduce((sum, sale) => sum + sale.total, 0);
            const totalProfitToday = salesToday.reduce((sum, sale) => sum + sale.profit, 0);

            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toDateString();
            }).reverse();

            const weeklyProfits = last7Days.map(day => {
                const dailySales = salesHistory.filter(sale => new Date(sale.date).toDateString() === day);
                return dailySales.reduce((sum, sale) => sum + sale.profit, 0);
            });

            const totalProfitWeek = weeklyProfits.reduce((sum, profit) => sum + profit, 0);
            const totalProfitMonth = salesHistory.filter(sale => {
                const saleDate = new Date(sale.date);
                const now = new Date();
                return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
            }).reduce((sum, sale) => sum + sale.profit, 0);

            // Actualizar el DOM
            $('salesToday').textContent = formatCurrency(totalSalesToday);
            $('profitToday').textContent = formatCurrency(totalProfitToday);
            $('profitWeek').textContent = formatCurrency(totalProfitWeek);
            $('profitMonth').textContent = formatCurrency(totalProfitMonth);

            // Gráfico de ganancias semanales
            if (weeklyProfitChart) {
                weeklyProfitChart.destroy();
            }
            const ctx = $('weeklyProfitChart').getContext('2d');
            weeklyProfitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(day => day.split(' ')[0]),
                    datasets: [{
                        label: 'Ganancia Semanal',
                        data: weeklyProfits,
                        backgroundColor: '#9333ea',
                        borderColor: '#c084fc',
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                }
            });

            // Stock crítico
            const criticalStockList = $('criticalStock');
            criticalStockList.innerHTML = '';
            const criticalProducts = products.filter(p => p.stock < 5);
            if (criticalProducts.length === 0) {
                criticalStockList.innerHTML = '<p class="text-gray-400">No hay productos con stock crítico.</p>';
            } else {
                criticalProducts.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'bg-red-900/40 p-3 rounded-lg flex justify-between items-center';
                    productItem.innerHTML = `
                        <span>${product.name}</span>
                        <span class="font-bold text-red-400">${product.stock} unidades</span>
                    `;
                    criticalStockList.appendChild(productItem);
                });
            }
        }

        // --- Gestión de Productos ---

        // Abrir modal de agregar producto
        $('addProductBtn').addEventListener('click', () => {
            if (isAdminSessionActive && currentAdminSection === 'products') {
                showProductModal();
            } else {
                promptForPassword(() => {
                    showProductModal();
                }, 'products');
            }
        });

        // Lógica para mostrar y ocultar el modal
        const productModal = $('productModal');
        const productForm = $('productForm');
        const modalTitle = $('modalTitle');
        const productIdInput = $('productId');

        function showProductModal(product = null) {
            productForm.reset();
            if (product) {
                modalTitle.textContent = 'Editar Producto';
                productIdInput.value = product.id;
                $('productName').value = product.name;
                $('productCategory').value = product.category;
                $('productStock').value = product.stock;
                $('productCost').value = product.cost;
                $('productPrice').value = product.price;
                $('productImage').value = product.image || '';
            } else {
                modalTitle.textContent = 'Agregar Producto';
                productIdInput.value = '';
            }
            productModal.classList.remove('hidden');
            productModal.classList.add('flex');
        }

        $('cancelProductBtn').addEventListener('click', () => {
            productModal.classList.add('hidden');
            productModal.classList.remove('flex');
            // Si la sesión de admin está activa, no la cierres
            if (!isAdminSessionActive) {
                $('exitProductAdminBtn').classList.add('hidden');
                currentAdminSection = '';
            }
        });

        // Formulario de agregar/editar producto
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = productIdInput.value;
            const name = $('productName').value;
            const category = $('productCategory').value;
            const stock = parseInt($('productStock').value);
            const cost = parseFloat($('productCost').value);
            const price = parseFloat($('productPrice').value);
            const image = $('productImage').value;

            if (id) {
                // Editar producto
                const productIndex = products.findIndex(p => p.id === id);
                if (productIndex > -1) {
                    products[productIndex] = { ...products[productIndex], name, category, stock, cost, price, image };
                    showToast('Producto actualizado correctamente.', 'success');
                }
            } else {
                // Agregar producto
                const newProduct = {
                    id: Date.now().toString(),
                    name,
                    category,
                    stock,
                    cost,
                    price,
                    image
                };
                products.push(newProduct);
                showToast('Producto agregado correctamente.', 'success');
            }
            saveData();
            renderAll();
            productModal.classList.add('hidden');
            productModal.classList.remove('flex');
        });

        function renderProductsTable() {
            const tableBody = $('productsTableBody');
            tableBody.innerHTML = '';
            const searchText = $('productSearch').value.toLowerCase();
            const categoryFilter = $('categoryFilter').value;

            const filteredProducts = products.filter(p =>
                (p.name.toLowerCase().includes(searchText) || p.category.toLowerCase().includes(searchText)) &&
                (categoryFilter === '' || p.category === categoryFilter)
            );

            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b border-emerald-500/10 hover:bg-emerald-900/20 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-4">${product.name}</td>
                    <td class="p-4">${product.category}</td>
                    <td class="p-4">${product.stock}</td>
                    <td class="p-4">${formatCurrency(product.cost)}</td>
                    <td class="p-4">${formatCurrency(product.price)}</td>
                    <td class="p-4">
                        <button class="edit-btn text-yellow-400 hover:text-yellow-600 font-bold px-2 py-1 rounded-lg" data-id="${product.id}">Editar</button>
                        <button class="delete-btn text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded-lg ml-2" data-id="${product.id}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const productToEdit = products.find(p => p.id === id);
                    if (isAdminSessionActive && currentAdminSection === 'products') {
                        showProductModal(productToEdit);
                    } else {
                        promptForPassword(() => {
                            showProductModal(productToEdit);
                        }, 'products');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    if (isAdminSessionActive && currentAdminSection === 'products') {
                        deleteProduct(id);
                    } else {
                        promptForPassword(() => {
                            deleteProduct(id);
                        }, 'products');
                    }
                });
            });
        }

        function deleteProduct(id) {
            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex > -1) {
                products.splice(productIndex, 1);
                saveData();
                showToast('Producto eliminado correctamente.', 'success');
                renderAll();
            }
        }

        $('productSearch').addEventListener('input', renderProductsTable);
        $('categoryFilter').addEventListener('change', renderProductsTable);

        function populateCategoryFilter() {
            const select = $('categoryFilter');
            select.innerHTML = '<option value="">Todas las categorías</option>';
            const categories = [...new Set(products.map(p => p.category))];
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        // --- Lógica de Ventas ---

        function renderAvailableProductsTable() {
            const tableBody = $('availableProductsTableBody');
            tableBody.innerHTML = '';
            const searchText = $('saleProductSearch').value.toLowerCase();
            const filteredProducts = products.filter(p =>
                p.stock > 0 && p.name.toLowerCase().includes(searchText)
            );

            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b border-emerald-500/10 hover:bg-emerald-900/20 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-4">${product.name}</td>
                    <td class="p-4 text-center">${product.stock}</td>
                    <td class="p-4 text-center">${formatCurrency(product.price)}</td>
                    <td class="p-4 text-center">
                        <button class="add-to-sale-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg" data-id="${product.id}">+</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.add-to-sale-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    addProductToSale(id);
                });
            });
        }

        function addProductToSale(id) {
            const product = products.find(p => p.id === id);
            if (!product || product.stock <= 0) {
                showToast('Stock insuficiente.', 'error');
                return;
            }

            const existingItem = currentSale.find(item => item.id === id);
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showToast('No se puede agregar más, stock agotado.', 'error');
                    return;
                }
                existingItem.quantity++;
            } else {
                currentSale.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    cost: product.cost,
                    quantity: 1
                });
            }
            saveData();
            renderCurrentSale();
            renderAvailableProductsTable();
        }

        function renderCurrentSale() {
            const tableBody = $('currentSaleTableBody');
            tableBody.innerHTML = '';
            let total = 0;

            currentSale.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                const row = document.createElement('tr');
                row.className = 'border-b border-emerald-500/10';
                row.innerHTML = `
                    <td class="p-4">${item.name}</td>
                    <td class="p-4 text-center">
                        <input type="number" min="1" value="${item.quantity}" class="quantity-input w-16 bg-gray-700/50 border border-emerald-500/30 rounded text-center" data-id="${item.id}">
                    </td>
                    <td class="p-4 text-center">${formatCurrency(item.price)}</td>
                    <td class="p-4 text-right">${formatCurrency(subtotal)}</td>
                    <td class="p-4">
                        <button class="remove-from-sale-btn text-red-400 hover:text-red-600 font-bold" data-id="${item.id}">X</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            $('saleTotal').textContent = formatCurrency(total);
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const newQuantity = parseInt(e.target.value);
                    const productInStock = products.find(p => p.id === id);
                    if (newQuantity < 1) {
                        e.target.value = 1;
                        showToast('La cantidad no puede ser menor a 1.', 'error');
                        return;
                    }
                    if (newQuantity > productInStock.stock) {
                        e.target.value = productInStock.stock;
                        showToast(`No hay suficiente stock. Máximo: ${productInStock.stock}`, 'error');
                        return;
                    }
                    const item = currentSale.find(i => i.id === id);
                    if (item) {
                        item.quantity = newQuantity;
                        saveData();
                        renderCurrentSale();
                    }
                });
            });

            document.querySelectorAll('.remove-from-sale-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    currentSale = currentSale.filter(item => item.id !== id);
                    saveData();
                    renderCurrentSale();
                    renderAvailableProductsTable();
                });
            });
        }

        $('saleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentSale.length === 0) {
                showToast('La venta está vacía.', 'error');
                return;
            }

            const total = currentSale.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const profit = currentSale.reduce((sum, item) => sum + (item.price - item.cost) * item.quantity, 0);
            const paymentMethod = $('salePaymentMethod').value;
            const date = new Date().toISOString();

            // Actualizar stock de productos
            currentSale.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                }
            });

            const newSale = {
                id: Date.now().toString(),
                items: currentSale,
                total,
                profit,
                paymentMethod,
                date
            };

            salesHistory.push(newSale);
            currentSale = [];
            saveData();
            showToast('Venta confirmada exitosamente.', 'success');
            renderAll();
        });

        $('saleProductSearch').addEventListener('input', renderAvailableProductsTable);

        // --- Reportes ---

        function renderReportsTable() {
            const tableBody = $('reportsTableBody');
            tableBody.innerHTML = '';
            const productReport = {};

            salesHistory.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productReport[item.id]) {
                        productReport[item.id] = {
                            name: item.name,
                            unitsSold: 0,
                            totalSales: 0,
                            totalProfit: 0
                        };
                    }
                    productReport[item.id].unitsSold += item.quantity;
                    productReport[item.id].totalSales += item.price * item.quantity;
                    productReport[item.id].totalProfit += (item.price - item.cost) * item.quantity;
                });
            });

            for (const id in productReport) {
                const report = productReport[id];
                const row = document.createElement('tr');
                row.className = 'border-b border-emerald-500/10 hover:bg-emerald-900/20 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-4">${report.name}</td>
                    <td class="p-4">${report.unitsSold}</td>
                    <td class="p-4">${formatCurrency(report.totalSales)}</td>
                    <td class="p-4">${formatCurrency(report.totalProfit)}</td>
                `;
                tableBody.appendChild(row);
            }
        }

        // Exportar a CSV
        $('exportCsvBtn').addEventListener('click', () => {
            const reportData = [['Producto', 'Unidades Vendidas', 'Ventas Totales', 'Ganancia Total']];
            const productReport = {};

            salesHistory.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productReport[item.id]) {
                        productReport[item.id] = {
                            name: item.name,
                            unitsSold: 0,
                            totalSales: 0,
                            totalProfit: 0
                        };
                    }
                    productReport[item.id].unitsSold += item.quantity;
                    productReport[item.id].totalSales += item.price * item.quantity;
                    productReport[item.id].totalProfit += (item.price - item.cost) * item.quantity;
                });
            });

            for (const id in productReport) {
                const report = productReport[id];
                reportData.push([
                    report.name,
                    report.unitsSold,
                    report.totalSales.toFixed(2),
                    report.totalProfit.toFixed(2)
                ]);
            }

            const csvContent = "data:text/csv;charset=utf-8," + reportData.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reporte_kiosco.csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
            showToast('Reporte exportado como CSV.', 'success');
        });

        // --- Balance ---
        function renderBalanceCharts() {
            // Stock por categoría
            const categoryStock = {};
            products.forEach(p => {
                if (!categoryStock[p.category]) {
                    categoryStock[p.category] = 0;
                }
                categoryStock[p.category] += p.stock;
            });

            const categoryBalanceList = $('categoryBalance');
            categoryBalanceList.innerHTML = '';
            for (const category in categoryStock) {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-700/50 p-3 rounded-lg';
                item.innerHTML = `
                    <span>${category}</span>
                    <span class="font-bold text-emerald-300">${categoryStock[category]} unidades</span>
                `;
                categoryBalanceList.appendChild(item);
            }

            // Gráfico de distribución de stock
            if (categoryStockChart) {
                categoryStockChart.destroy();
            }
            const ctx2 = $('categoryStockChart').getContext('2d');
            const labels = Object.keys(categoryStock);
            const data = Object.values(categoryStock);
            const colors = labels.map(() => `#${Math.floor(Math.random() * 16777215).toString(16)}`);

            categoryStockChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                }
            });
        }

        // --- Historial de Ventas ---

        function renderHistoryTable() {
            const tableBody = $('historyTableBody');
            tableBody.innerHTML = '';

            // Mostrar el historial de ventas más reciente primero
            const sortedHistory = [...salesHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedHistory.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'border-b border-emerald-500/10 hover:bg-emerald-900/20 transition-colors duration-200';
                const date = new Date(sale.date).toLocaleString('es-AR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                row.innerHTML = `
                    <td class="p-4">${sale.id.slice(-6)}</td>
                    <td class="p-4">${date}</td>
                    <td class="p-4">${formatCurrency(sale.total)}</td>
                    <td class="p-4">${formatCurrency(sale.profit)}</td>
                    <td class="p-4">${sale.paymentMethod}</td>
                    <td class="p-4">
                        <button class="delete-sale-btn text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded-lg" data-id="${sale.id}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.delete-sale-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    promptForPassword(() => {
                        deleteSale(id);
                    }, 'history');
                });
            });
        }

        function deleteSale(id) {
            const saleIndex = salesHistory.findIndex(s => s.id === id);
            if (saleIndex > -1) {
                const saleToDelete = salesHistory[saleIndex];

                // Devolver el stock de los productos vendidos
                saleToDelete.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                    }
                });

                // Eliminar la venta del historial
                salesHistory.splice(saleIndex, 1);
                saveData();
                showToast('Venta eliminada correctamente y stock restaurado.', 'success');
                renderAll();
            }
        }

        // --- Botón de Reinicio ---
        $('resetDailySalesBtn').addEventListener('click', () => {
            promptForPassword(() => {
                const today = new Date().toDateString();
                salesHistory = salesHistory.filter(sale => new Date(sale.date).toDateString() !== today);
                currentSale = [];
                saveData();
                showToast('Ventas del día reiniciadas.', 'success');
                renderAll();
            }, 'daily-reset');
        });

    </script>

</body>
</html>
